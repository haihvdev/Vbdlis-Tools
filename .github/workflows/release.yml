name: Build and Release

on:
  push:
    tags:
      - "v*.*.*" # Triggers on version tags like v1.0.25120905
  workflow_dispatch: # Allow manual trigger

jobs:
  prepare-version:
    name: Prepare Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      tag-name: ${{ steps.get-version.outputs.tag-name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag or version.json
        id: get-version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Extract version from tag (e.g., v1.0.25120905 -> 1.0.25120905)
            VERSION="${GITHUB_REF#refs/tags/v}"
            TAG_NAME="${GITHUB_REF#refs/tags/}"
          else
            # Read from version.json
            VERSION=$(cat build/version.json | grep -o '"currentVersion"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)
            TAG_NAME="v$VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag-name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building version: $VERSION"

  build-windows:
    name: Build Windows
    needs: prepare-version
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Install Velopack CLI
        run: dotnet tool install --global vpk

      - name: Build Windows with Velopack
        run: .\build\windows-velopack.ps1
        shell: pwsh

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            dist/velopack/*-Setup.zip
            dist/velopack/*.nupkg
            dist/velopack/RELEASES
          retention-days: 5

  build-macos:
    name: Build macOS (Apple Silicon)
    needs: prepare-version
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Install Velopack CLI
        run: dotnet tool install --global vpk

      - name: Build macOS with Velopack
        run: |
          chmod +x ./build/macos.sh
          ./build/macos.sh Release arm64

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-release
          path: |
            dist/velopack-macos/arm64/*.dmg
          retention-days: 5

  create-release:
    name: Create GitHub Release
    needs: [prepare-version, build-windows, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Generate release notes
        id: release-notes
        run: |
          VERSION="${{ needs.prepare-version.outputs.version }}"
          cat > release-notes.md << 'EOF'
          ## ðŸŽ‰ VBDLIS Tools v$VERSION

          ### ðŸ“¦ Downloads

          #### Windows
          - **VbdlisTools-$VERSION-Setup.zip** - Installer cho Windows (giáº£i nÃ©n vÃ  cháº¡y Setup.exe)
          - Há»— trá»£ auto-update qua Velopack
          - **LÆ°u Ã½:** Táº£i file ZIP Ä‘á»ƒ trÃ¡nh cáº£nh bÃ¡o cá»§a trÃ¬nh duyá»‡t

          #### macOS
          - **VbdlisTools-$VERSION-osx-arm64.dmg** - Cho Mac M1/M2/M3/M4 (Apple Silicon)
          - Drag & drop vÃ o Applications folder
          - **LÆ°u Ã½:** Chá»‰ há»— trá»£ Apple Silicon. Mac Intel (x64) khÃ´ng cÃ²n Ä‘Æ°á»£c há»— trá»£.

          ### ðŸš€ Installation

          **Windows:**
          1. Táº£i file `VbdlisTools-$VERSION-Setup.zip`
          2. Giáº£i nÃ©n ZIP file
          3. Cháº¡y `VbdlisTools-$VERSION-Setup.exe`
          4. á»¨ng dá»¥ng tá»± Ä‘á»™ng update khi cÃ³ phiÃªn báº£n má»›i

          **macOS (Apple Silicon only):**
          1. Táº£i file `VbdlisTools-$VERSION-osx-arm64.dmg`
          2. Má»Ÿ DMG file
          3. KÃ©o `VbdlisTools.app` vÃ o thÆ° má»¥c Applications
          4. **Fix "App is damaged" error:**
             - Má»Ÿ Terminal (Applications â†’ Utilities â†’ Terminal)
             - Cháº¡y lá»‡nh: `xattr -cr /Applications/VbdlisTools.app`
          5. Giá» cÃ³ thá»ƒ má»Ÿ app bÃ¬nh thÆ°á»ng
          6. á»¨ng dá»¥ng tá»± Ä‘á»™ng update khi cÃ³ phiÃªn báº£n má»›i

          ### âš ï¸ Important Notes

          - **macOS "App is damaged" Error**: 
            - App chÆ°a Ä‘Æ°á»£c kÃ½ sá»‘ bá»Ÿi Apple Developer
            - Cháº¡y lá»‡nh `xattr -cr /Applications/VbdlisTools.app` trong Terminal Ä‘á»ƒ fix
            - Hoáº·c: Right-click app â†’ Show Package Contents (workaround)
          - **Playwright Browsers**: Sáº½ tá»± Ä‘á»™ng táº£i xuá»‘ng khi cháº¡y láº§n Ä‘áº§u tiÃªn
          - **Auto-Update**: á»¨ng dá»¥ng tá»± Ä‘á»™ng kiá»ƒm tra vÃ  cáº­p nháº­t phiÃªn báº£n má»›i
          - **Minimum Requirements**:
            - Windows: Windows 10 64-bit or later
            - macOS: macOS 10.15 (Catalina) or later, Apple Silicon only

          ### ðŸ› Bug Fixes & Improvements

          - Cáº£i thiá»‡n hiá»‡u suáº¥t
          - Sá»­a lá»—i vÃ  tá»‘i Æ°u hÃ³a

          ---

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v1.0.0...v$VERSION
          EOF

          # Replace $VERSION with actual version
          sed -i "s/\$VERSION/$VERSION/g" release-notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-version.outputs.tag-name }}
          name: Release ${{ needs.prepare-version.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: |
            artifacts/windows-release/*
            artifacts/macos-arm64-release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to release server (optional)
        if: false # Enable this if you have a custom release server
        run: |
          # Example: rsync or scp to your web server
          # rsync -avz artifacts/ user@server:/path/to/releases/
          echo "Upload to custom server disabled. Enable by setting 'if: true' above."
